<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.FinancialAnalysisMapper">

    <!-- 获取财务仪表盘数据 -->
    <select id="getFinancialDashboardData" resultType="map">
        SELECT 
            'totalRevenue' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
        UNION ALL
        SELECT 
            'totalProfit' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                             WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES') THEN -amount 
                             ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.transaction_date >= DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
        UNION ALL
        SELECT 
            'totalAssets' as metric,
            COALESCE(SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END), 0) as value
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'cashFlow' as metric,
            COALESCE(SUM(amount), 0) as value
        FROM erp_cash_flow
        WHERE period = DATE_FORMAT(CURDATE(), '%Y-%m')
    </select>

    <!-- 获取收入概览数据 -->
    <select id="getRevenueOverviewData" resultType="map">
        SELECT 
            'currentMonthRevenue' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'lastMonthRevenue' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y-%m')
        UNION ALL
        SELECT 
            'yearToDateRevenue' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE YEAR(ft.transaction_date) = YEAR(CURDATE())
    </select>

    <!-- 获取利润概览数据 -->
    <select id="getProfitOverviewData" resultType="map">
        SELECT 
            'grossProfit' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                             WHEN account_type = 'COST_OF_GOODS_SOLD' THEN -amount 
                             ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'operatingProfit' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                             WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES') THEN -amount 
                             ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'netProfit' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                             WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                             WHEN account_type = 'OTHER_INCOME' THEN amount
                             ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
    </select>

    <!-- 获取现金流概览数据 -->
    <select id="getCashflowOverviewData" resultType="map">
        SELECT 
            'operatingCashFlow' as metric,
            COALESCE(SUM(CASE WHEN cash_flow_type = 'OPERATING' THEN amount ELSE 0 END), 0) as value
        FROM erp_cash_flow
        WHERE period = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'investingCashFlow' as metric,
            COALESCE(SUM(CASE WHEN cash_flow_type = 'INVESTING' THEN amount ELSE 0 END), 0) as value
        FROM erp_cash_flow
        WHERE period = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'financingCashFlow' as metric,
            COALESCE(SUM(CASE WHEN cash_flow_type = 'FINANCING' THEN amount ELSE 0 END), 0) as value
        FROM erp_cash_flow
        WHERE period = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'netCashFlow' as metric,
            COALESCE(SUM(amount), 0) as value
        FROM erp_cash_flow
        WHERE period = DATE_FORMAT(CURDATE(), '%Y-%m')
    </select>

    <!-- 获取费用概览数据 -->
    <select id="getExpensesOverviewData" resultType="map">
        SELECT 
            'operatingExpenses' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'OPERATING_EXPENSES' THEN amount ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'costOfGoodsSold' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'COST_OF_GOODS_SOLD' THEN amount ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'otherExpenses' as metric,
            COALESCE(SUM(CASE WHEN account_type = 'OTHER_EXPENSES' THEN amount ELSE 0 END), 0) as value
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE DATE_FORMAT(ft.transaction_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
    </select>

    <!-- 获取资产负债概览数据 -->
    <select id="getBalanceSheetOverviewData" resultType="map">
        SELECT 
            'totalAssets' as metric,
            COALESCE(SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END), 0) as value
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'totalLiabilities' as metric,
            COALESCE(SUM(CASE WHEN account_category = 'LIABILITIES' THEN balance ELSE 0 END), 0) as value
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = DATE_FORMAT(CURDATE(), '%Y-%m')
        UNION ALL
        SELECT 
            'totalEquity' as metric,
            COALESCE(SUM(CASE WHEN account_category = 'EQUITY' THEN balance ELSE 0 END), 0) as value
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = DATE_FORMAT(CURDATE(), '%Y-%m')
    </select>

    <!-- 获取财务比率分析数据 -->
    <select id="getFinancialRatioAnalysisData" resultType="map">
        SELECT 
            'currentRatio' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END) > 0
                THEN ROUND(SUM(CASE WHEN account_type = 'CURRENT_ASSETS' THEN balance ELSE 0 END) / 
                          SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END), 2)
                ELSE 0
            END as ratioValue
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = #{period}
        UNION ALL
        SELECT 
            'debtToEquityRatio' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_category = 'EQUITY' THEN balance ELSE 0 END) > 0
                THEN ROUND(SUM(CASE WHEN account_category = 'LIABILITIES' THEN balance ELSE 0 END) / 
                          SUM(CASE WHEN account_category = 'EQUITY' THEN balance ELSE 0 END), 2)
                ELSE 0
            END as ratioValue
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = #{period}
        UNION ALL
        SELECT 
            'returnOnAssets' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END) > 0
                THEN ROUND((SELECT SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                                           WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                                           WHEN account_type = 'OTHER_INCOME' THEN amount
                                           ELSE 0 END)
                           FROM erp_financial_transaction ft2
                           JOIN erp_chart_of_accounts coa2 ON ft2.account_id = coa2.account_id
                           WHERE ft2.period = #{period}) / 
                          SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END) * 100, 2)
                ELSE 0
            END as ratioValue
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = #{period}
    </select>

    <!-- 获取盈利能力比率数据 -->
    <select id="getProfitabilityRatiosData" resultType="map">
        SELECT 
            'grossProfitMargin' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) > 0
                THEN ROUND((SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) - 
                           SUM(CASE WHEN account_type = 'COST_OF_GOODS_SOLD' THEN amount ELSE 0 END)) / 
                          SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) * 100, 2)
                ELSE 0
            END as ratioValue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period = #{period}
        UNION ALL
        SELECT 
            'operatingProfitMargin' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) > 0
                THEN ROUND((SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) - 
                           SUM(CASE WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES') THEN amount ELSE 0 END)) / 
                          SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) * 100, 2)
                ELSE 0
            END as ratioValue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period = #{period}
        UNION ALL
        SELECT 
            'netProfitMargin' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) > 0
                THEN ROUND((SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                                    WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                                    WHEN account_type = 'OTHER_INCOME' THEN amount
                                    ELSE 0 END)) / 
                          SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) * 100, 2)
                ELSE 0
            END as ratioValue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period = #{period}
    </select>

    <!-- 获取偿债能力比率数据 -->
    <select id="getSolvencyRatiosData" resultType="map">
        SELECT 
            'currentRatio' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END) > 0
                THEN ROUND(SUM(CASE WHEN account_type = 'CURRENT_ASSETS' THEN balance ELSE 0 END) / 
                          SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END), 2)
                ELSE 0
            END as ratioValue
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = #{period}
        UNION ALL
        SELECT 
            'quickRatio' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END) > 0
                THEN ROUND((SUM(CASE WHEN account_type = 'CURRENT_ASSETS' THEN balance ELSE 0 END) - 
                           SUM(CASE WHEN account_name LIKE '%库存%' OR account_name LIKE '%存货%' THEN balance ELSE 0 END)) / 
                          SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END), 2)
                ELSE 0
            END as ratioValue
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = #{period}
        UNION ALL
        SELECT 
            'debtRatio' as ratioType,
            CASE 
                WHEN SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END) > 0
                THEN ROUND(SUM(CASE WHEN account_category = 'LIABILITIES' THEN balance ELSE 0 END) / 
                          SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END) * 100, 2)
                ELSE 0
            END as ratioValue
        FROM erp_account_balance ab
        JOIN erp_chart_of_accounts coa ON ab.account_id = coa.account_id
        WHERE ab.period = #{period}
    </select>

    <!-- 获取营运能力比率数据 -->
    <select id="getOperationRatiosData" resultType="map">
        SELECT 
            'assetTurnover' as ratioType,
            CASE 
                WHEN (SELECT SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END)
                      FROM erp_account_balance ab2
                      JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                      WHERE ab2.period = #{period}) > 0
                THEN ROUND(SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) / 
                          (SELECT SUM(CASE WHEN account_category = 'ASSETS' THEN balance ELSE 0 END)
                           FROM erp_account_balance ab2
                           JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                           WHERE ab2.period = #{period}), 2)
                ELSE 0
            END as ratioValue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period = #{period}
        UNION ALL
        SELECT 
            'inventoryTurnover' as ratioType,
            CASE 
                WHEN (SELECT SUM(CASE WHEN account_name LIKE '%库存%' OR account_name LIKE '%存货%' THEN balance ELSE 0 END)
                      FROM erp_account_balance ab2
                      JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                      WHERE ab2.period = #{period}) > 0
                THEN ROUND(SUM(CASE WHEN account_type = 'COST_OF_GOODS_SOLD' THEN amount ELSE 0 END) / 
                          (SELECT SUM(CASE WHEN account_name LIKE '%库存%' OR account_name LIKE '%存货%' THEN balance ELSE 0 END)
                           FROM erp_account_balance ab2
                           JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                           WHERE ab2.period = #{period}), 2)
                ELSE 0
            END as ratioValue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period = #{period}
    </select>

    <!-- 获取发展能力比率数据 -->
    <select id="getGrowthRatiosData" resultType="map">
        SELECT 
            'revenueGrowthRate' as ratioType,
            CASE 
                WHEN (SELECT SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END)
                      FROM erp_financial_transaction ft2
                      JOIN erp_chart_of_accounts coa2 ON ft2.account_id = coa2.account_id
                      WHERE ft2.period = DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{period}, '-01'), '%Y-%m-%d'), INTERVAL 1 YEAR), '%Y-%m')) > 0
                THEN ROUND((SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END) - 
                           (SELECT SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END)
                            FROM erp_financial_transaction ft2
                            JOIN erp_chart_of_accounts coa2 ON ft2.account_id = coa2.account_id
                            WHERE ft2.period = DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{period}, '-01'), '%Y-%m-%d'), INTERVAL 1 YEAR), '%Y-%m'))) / 
                          (SELECT SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END)
                           FROM erp_financial_transaction ft2
                           JOIN erp_chart_of_accounts coa2 ON ft2.account_id = coa2.account_id
                           WHERE ft2.period = DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{period}, '-01'), '%Y-%m-%d'), INTERVAL 1 YEAR), '%Y-%m')) * 100, 2)
                ELSE 0
            END as ratioValue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period = #{period}
        UNION ALL
        SELECT 
            'profitGrowthRate' as ratioType,
            CASE 
                WHEN (SELECT SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                                     WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                                     WHEN account_type = 'OTHER_INCOME' THEN amount
                                     ELSE 0 END)
                      FROM erp_financial_transaction ft2
                      JOIN erp_chart_of_accounts coa2 ON ft2.account_id = coa2.account_id
                      WHERE ft2.period = DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{period}, '-01'), '%Y-%m-%d'), INTERVAL 1 YEAR), '%Y-%m')) > 0
                THEN ROUND((SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                                    WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                                    WHEN account_type = 'OTHER_INCOME' THEN amount
                                    ELSE 0 END) - 
                           (SELECT SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                                           WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                                           WHEN account_type = 'OTHER_INCOME' THEN amount
                                           ELSE 0 END)
                            FROM erp_financial_transaction ft2
                            JOIN erp_chart_of_accounts coa2 ON ft2.account_id = coa2.account_id
                            WHERE ft2.period = DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{period}, '-01'), '%Y-%m-%d'), INTERVAL 1 YEAR), '%Y-%m'))) / 
                          (SELECT SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                                          WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                                          WHEN account_type = 'OTHER_INCOME' THEN amount
                                          ELSE 0 END)
                           FROM erp_financial_transaction ft2
                           JOIN erp_chart_of_accounts coa2 ON ft2.account_id = coa2.account_id
                           WHERE ft2.period = DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{period}, '-01'), '%Y-%m-%d'), INTERVAL 1 YEAR), '%Y-%m')) * 100, 2)
                ELSE 0
            END as ratioValue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period = #{period}
    </select>

    <!-- 获取现金流比率数据 -->
    <select id="getCashFlowRatiosData" resultType="map">
        SELECT 
            'operatingCashFlowRatio' as ratioType,
            CASE 
                WHEN (SELECT SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END)
                      FROM erp_account_balance ab2
                      JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                      WHERE ab2.period = #{period}) > 0
                THEN ROUND(SUM(CASE WHEN cash_flow_type = 'OPERATING' THEN amount ELSE 0 END) / 
                          (SELECT SUM(CASE WHEN account_type = 'CURRENT_LIABILITIES' THEN balance ELSE 0 END)
                           FROM erp_account_balance ab2
                           JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                           WHERE ab2.period = #{period}), 2)
                ELSE 0
            END as ratioValue
        FROM erp_cash_flow
        WHERE period = #{period}
        UNION ALL
        SELECT 
            'cashFlowCoverageRatio' as ratioType,
            CASE 
                WHEN (SELECT SUM(CASE WHEN account_category = 'LIABILITIES' THEN balance ELSE 0 END)
                      FROM erp_account_balance ab2
                      JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                      WHERE ab2.period = #{period}) > 0
                THEN ROUND(SUM(CASE WHEN cash_flow_type = 'OPERATING' THEN amount ELSE 0 END) / 
                          (SELECT SUM(CASE WHEN account_category = 'LIABILITIES' THEN balance ELSE 0 END)
                           FROM erp_account_balance ab2
                           JOIN erp_chart_of_accounts coa2 ON ab2.account_id = coa2.account_id
                           WHERE ab2.period = #{period}), 2)
                ELSE 0
            END as ratioValue
        FROM erp_cash_flow
        WHERE period = #{period}
    </select>

    <!-- 获取财务趋势分析数据 - 收入趋势 -->
    <select id="getRevenueTrendData" resultType="map">
        SELECT 
            ft.period,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount ELSE 0 END), 0) as revenue
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period BETWEEN #{startPeriod} AND #{endPeriod}
        GROUP BY ft.period
        ORDER BY ft.period
    </select>

    <!-- 获取财务趋势分析数据 - 利润趋势 -->
    <select id="getProfitTrendData" resultType="map">
        SELECT 
            ft.period,
            COALESCE(SUM(CASE WHEN account_type = 'REVENUE' THEN amount 
                             WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN -amount 
                             WHEN account_type = 'OTHER_INCOME' THEN amount
                             ELSE 0 END), 0) as profit
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period BETWEEN #{startPeriod} AND #{endPeriod}
        GROUP BY ft.period
        ORDER BY ft.period
    </select>

    <!-- 获取财务趋势分析数据 - 费用趋势 -->
    <select id="getExpenseTrendData" resultType="map">
        SELECT 
            ft.period,
            COALESCE(SUM(CASE WHEN account_type IN ('COST_OF_GOODS_SOLD', 'OPERATING_EXPENSES', 'OTHER_EXPENSES') THEN amount ELSE 0 END), 0) as expenses
        FROM erp_financial_transaction ft
        JOIN erp_chart_of_accounts coa ON ft.account_id = coa.account_id
        WHERE ft.period BETWEEN #{startPeriod} AND #{endPeriod}
        GROUP BY ft.period
        ORDER BY ft.period
    </select>

    <!-- 获取审计跟踪数据 -->
    <select id="getAuditTrailData" resultType="map">
        SELECT 
            audit_id as auditId,
            module,
            operation_type as operationType,
            operation_desc as operationDesc,
            operator_id as operatorId,
            operator_name as operatorName,
            operation_time as operationTime,
            ip_address as ipAddress,
            old_value as oldValue,
            new_value as newValue,
            remark
        FROM erp_audit_log
        WHERE 1=1
        <if test="module != null and module != ''">
            AND module = #{module}
        </if>
        <if test="startDate != null and startDate != ''">
            AND operation_time >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND operation_time &lt;= #{endDate}
        </if>
        ORDER BY operation_time DESC
        LIMIT 1000
    </select>

</mapper>