<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.asset.AssetDepreciationMapper">

    <!-- 结果映射 -->
    <resultMap id="AssetDepreciationResult" type="com.chennian.storytelling.bean.model.asset.AssetDepreciation">
        <id property="id" column="id"/>
        <result property="assetId" column="asset_id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="depreciationMonth" column="depreciation_month"/>
        <result property="depreciationMethod" column="depreciation_method"/>
        <result property="originalValue" column="original_value"/>
        <result property="accumulatedDepreciation" column="accumulated_depreciation"/>
        <result property="currentDepreciation" column="current_depreciation"/>
        <result property="netValue" column="net_value"/>
        <result property="usefulLife" column="useful_life"/>
        <result property="usedMonths" column="used_months"/>
        <result property="remainingMonths" column="remaining_months"/>
        <result property="depreciationRate" column="depreciation_rate"/>
        <result property="residualRate" column="residual_rate"/>
        <result property="residualValue" column="residual_value"/>
        <result property="status" column="status"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createBy" column="create_by"/>
        <result property="updateBy" column="update_by"/>
    </resultMap>

    <!-- 分页查询折旧记录 -->
    <select id="selectDepreciationPage" resultMap="AssetDepreciationResult">
        SELECT 
            d.*,
            a.asset_name
        FROM asset_depreciation d
        LEFT JOIN asset_info a ON d.asset_id = a.id
        <where>
            <if test="depreciation.assetId != null">
                AND d.asset_id = #{depreciation.assetId}
            </if>
            <if test="depreciation.assetCode != null and depreciation.assetCode != ''">
                AND d.asset_code LIKE CONCAT('%', #{depreciation.assetCode}, '%')
            </if>
            <if test="depreciation.assetName != null and depreciation.assetName != ''">
                AND d.asset_name LIKE CONCAT('%', #{depreciation.assetName}, '%')
            </if>
            <if test="depreciation.depreciationMonth != null and depreciation.depreciationMonth != ''">
                AND d.depreciation_month = #{depreciation.depreciationMonth}
            </if>
            <if test="depreciation.status != null">
                AND d.status = #{depreciation.status}
            </if>
        </where>
        ORDER BY d.depreciation_month DESC, d.create_time DESC
    </select>

    <!-- 根据资产ID查询最新折旧记录 -->
    <select id="selectLatestByAssetId" resultMap="AssetDepreciationResult">
        SELECT * FROM asset_depreciation 
        WHERE asset_id = #{assetId}
        ORDER BY depreciation_month DESC, create_time DESC
        LIMIT 1
    </select>

    <!-- 根据折旧年月查询记录 -->
    <select id="selectByDepreciationMonth" resultMap="AssetDepreciationResult">
        SELECT * FROM asset_depreciation 
        WHERE depreciation_month = #{depreciationMonth}
        ORDER BY asset_code
    </select>

    <!-- 根据资产ID和折旧年月查询记录 -->
    <select id="selectByAssetIdAndMonth" resultMap="AssetDepreciationResult">
        SELECT * FROM asset_depreciation 
        WHERE asset_id = #{assetId} AND depreciation_month = #{depreciationMonth}
    </select>

    <!-- 根据资产ID列表查询折旧记录 -->
    <select id="selectByAssetIds" resultMap="AssetDepreciationResult">
        SELECT * FROM asset_depreciation 
        WHERE depreciation_month = #{depreciationMonth}
        AND asset_id IN
        <foreach collection="assetIds" item="assetId" open="(" separator="," close=")">
            #{assetId}
        </foreach>
        ORDER BY asset_code
    </select>

    <!-- 查询折旧统计信息 -->
    <select id="selectDepreciationStatistics" resultType="java.util.Map">
        SELECT 
            depreciation_month,
            COUNT(*) as asset_count,
            SUM(original_value) as total_original_value,
            SUM(current_depreciation) as total_current_depreciation,
            SUM(accumulated_depreciation) as total_accumulated_depreciation,
            SUM(net_value) as total_net_value
        FROM asset_depreciation 
        <where>
            <if test="startMonth != null and startMonth != ''">
                AND depreciation_month >= #{startMonth}
            </if>
            <if test="endMonth != null and endMonth != ''">
                AND depreciation_month &lt;= #{endMonth}
            </if>
        </where>
        GROUP BY depreciation_month
        ORDER BY depreciation_month DESC
    </select>

    <!-- 查询需要计算折旧的资产 -->
    <select id="selectAssetsForDepreciation" resultType="java.util.Map">
        SELECT 
            a.id as asset_id,
            a.asset_code,
            a.asset_name,
            a.original_value,
            a.useful_life,
            a.residual_rate,
            a.purchase_date
        FROM asset_info a
        WHERE a.status = 1 -- 正常状态
        AND a.original_value > 0
        AND a.useful_life > 0
        AND NOT EXISTS (
            SELECT 1 FROM asset_depreciation d 
            WHERE d.asset_id = a.id 
            AND d.depreciation_month = #{depreciationMonth}
        )
        ORDER BY a.asset_code
    </select>

    <!-- 批量插入折旧记录 -->
    <insert id="batchInsert">
        INSERT INTO asset_depreciation (
            asset_id, asset_code, asset_name, depreciation_month, depreciation_method,
            original_value, accumulated_depreciation, current_depreciation, net_value,
            useful_life, used_months, remaining_months, depreciation_rate,
            residual_rate, residual_value, status, remark, create_time, create_by
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.assetId}, #{item.assetCode}, #{item.assetName}, #{item.depreciationMonth}, #{item.depreciationMethod},
                #{item.originalValue}, #{item.accumulatedDepreciation}, #{item.currentDepreciation}, #{item.netValue},
                #{item.usefulLife}, #{item.usedMonths}, #{item.remainingMonths}, #{item.depreciationRate},
                #{item.residualRate}, #{item.residualValue}, #{item.status}, #{item.remark}, #{item.createTime}, #{item.createBy}
            )
        </foreach>
    </insert>

    <!-- 更新折旧状态 -->
    <update id="updateDepreciationStatus">
        UPDATE asset_depreciation 
        SET status = #{status}, update_time = NOW()
        WHERE id = #{id}
    </update>

</mapper>