<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.manufacturing.BomTemplateMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.chennian.storytelling.bean.model.manufacturing.BomTemplate">
        <id column="bom_id" property="bomId" />
        <result column="bom_code" property="bomCode" />
        <result column="bom_name" property="bomName" />
        <result column="bom_version" property="bomVersion" />
        <result column="bom_type" property="bomType" />
        <result column="bom_status" property="bomStatus" />
        <result column="product_id" property="productId" />
        <result column="product_code" property="productCode" />
        <result column="product_name" property="productName" />
        <result column="product_spec" property="productSpec" />
        <result column="product_unit" property="productUnit" />
        <result column="base_quantity" property="baseQuantity" />
        <result column="batch_size" property="batchSize" />
        <result column="loss_rate" property="lossRate" />
        <result column="routing_id" property="routingId" />
        <result column="routing_name" property="routingName" />
        <result column="line_id" property="lineId" />
        <result column="line_name" property="lineName" />
        <result column="workshop_id" property="workshopId" />
        <result column="workshop_name" property="workshopName" />
        <result column="design_dept_id" property="designDeptId" />
        <result column="design_dept_name" property="designDeptName" />
        <result column="designer_id" property="designerId" />
        <result column="designer_name" property="designerName" />
        <result column="process_dept_id" property="processDeptId" />
        <result column="process_dept_name" property="processDeptName" />
        <result column="process_engineer_id" property="processEngineerId" />
        <result column="process_engineer_name" property="processEngineerName" />
        <result column="reviewer_id" property="reviewerId" />
        <result column="reviewer_name" property="reviewerName" />
        <result column="review_time" property="reviewTime" />
        <result column="review_comment" property="reviewComment" />
        <result column="publisher_id" property="publisherId" />
        <result column="publisher_name" property="publisherName" />
        <result column="publish_time" property="publishTime" />
        <result column="effective_date" property="effectiveDate" />
        <result column="expiry_date" property="expiryDate" />
        <result column="parent_bom_id" property="parentBomId" />
        <result column="parent_bom_code" property="parentBomCode" />
        <result column="bom_level" property="bomLevel" />
        <result column="is_leaf" property="isLeaf" />
        <result column="total_material_cost" property="totalMaterialCost" />
        <result column="total_labor_cost" property="totalLaborCost" />
        <result column="manufacturing_cost" property="manufacturingCost" />
        <result column="total_cost" property="totalCost" />
        <result column="standard_hours" property="standardHours" />
        <result column="setup_hours" property="setupHours" />
        <result column="process_hours" property="processHours" />
        <result column="quality_requirements" property="qualityRequirements" />
        <result column="technical_requirements" property="technicalRequirements" />
        <result column="process_requirements" property="processRequirements" />
        <result column="safety_requirements" property="safetyRequirements" />
        <result column="environmental_requirements" property="environmentalRequirements" />
        <result column="change_reason" property="changeReason" />
        <result column="change_description" property="changeDescription" />
        <result column="description" property="description" />
        <result column="remark" property="remark" />
        <result column="create_by" property="createBy" />
        <result column="create_time" property="createTime" />
        <result column="update_by" property="updateBy" />
        <result column="update_time" property="updateTime" />
        <result column="del_flag" property="delFlag" />
    </resultMap>

    <!-- 更新模板状态 -->
    <update id="updateTemplateStatus">
        UPDATE bom_template
        SET status = #{status},
            update_time = NOW()
        WHERE bom_id = #{templateId}
    </update>
    
    <!-- 根据产品ID查询模板列表 -->
    <select id="selectByProductId" resultMap="BaseResultMap">
        SELECT * FROM bom_template 
        WHERE product_id = #{productId}
        ORDER BY version DESC
    </select>
    
    <!-- 根据产品编号查询模板列表 -->
    <select id="selectByProductCode" resultMap="BaseResultMap">
        SELECT * FROM bom_template 
        WHERE product_code = #{productCode}
        ORDER BY version DESC
    </select>
    
    <!-- 根据状态查询模板列表 -->
    <select id="selectByStatus" resultMap="BaseResultMap">
        SELECT * FROM bom_template 
        WHERE status = #{status}
        ORDER BY create_time DESC
    </select>
    
    <!-- 查询模板统计信息 -->
    <select id="selectTemplateStatistics" resultType="java.util.Map">
        SELECT 
            COUNT(*) as totalTemplates,
            COUNT(CASE WHEN status = 0 THEN 1 END) as draftCount,
            COUNT(CASE WHEN status = 1 THEN 1 END) as auditedCount,
            COUNT(CASE WHEN status = 2 THEN 1 END) as publishedCount,
            COUNT(CASE WHEN status = 3 THEN 1 END) as frozenCount,
            COUNT(DISTINCT product_id) as productCount,
            COUNT(DISTINCT product_code) as productCodeCount,
            AVG(version) as avgVersion,
            MAX(version) as maxVersion
        FROM bom_template
        WHERE 1=1
        <if test="productId != null">
            AND product_id = #{productId}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="startDate != null and startDate != ''">
            AND create_time >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND create_time &lt;= #{endDate}
        </if>
    </select>
    
    <!-- 审核模板 -->
    <update id="approveTemplate">
        UPDATE bom_template
        SET status = 1,
            reviewer_id = #{reviewerId},
            reviewer_name = #{reviewerName},
            review_time = #{reviewTime},
            update_time = NOW()
        WHERE bom_id = #{templateId}
    </update>
    
    <!-- 发布模板 -->
    <update id="publishTemplate">
        UPDATE bom_template
        SET status = 2,
            update_time = NOW()
        WHERE bom_id = #{templateId}
    </update>
    
    <!-- 冻结模板 -->
    <update id="freezeTemplate">
        UPDATE bom_template
        SET status = 3,
            update_time = NOW()
        WHERE bom_id = #{templateId}
    </update>

</mapper>