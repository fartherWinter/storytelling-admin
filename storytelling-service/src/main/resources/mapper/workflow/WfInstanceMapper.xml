<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.workflow.WfInstanceMapper">

    <!-- 工作流实例结果映射 -->
    <resultMap id="WfInstanceResult" type="com.chennian.storytelling.bean.model.workflow.WfInstance">
        <id property="id" column="id"/>
        <result property="instanceId" column="instance_id"/>
        <result property="processDefinitionId" column="process_definition_id"/>
        <result property="processDefinitionKey" column="process_definition_key"/>
        <result property="processDefinitionName" column="process_definition_name"/>
        <result property="processDefinitionVersion" column="process_definition_version"/>
        <result property="businessKey" column="business_key"/>
        <result property="instanceName" column="instance_name"/>
        <result property="instanceStatus" column="instance_status"/>
        <result property="startUserId" column="start_user_id"/>
        <result property="startUserName" column="start_user_name"/>
        <result property="startDeptId" column="start_dept_id"/>
        <result property="startDeptName" column="start_dept_name"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="duration" column="duration"/>
        <result property="suspensionState" column="suspension_state"/>
        <result property="priority" column="priority"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="deleteReason" column="delete_reason"/>
        <result property="superProcessInstanceId" column="super_process_instance_id"/>
        <result property="rootProcessInstanceId" column="root_process_instance_id"/>
        <result property="callbackId" column="callback_id"/>
        <result property="callbackType" column="callback_type"/>
        <result property="referenceId" column="reference_id"/>
        <result property="referenceType" column="reference_type"/>
        <result property="propagatedStageInstanceId" column="propagated_stage_instance_id"/>
        <result property="businessStatus" column="business_status"/>
        <result property="createdTime" column="created_time"/>
        <result property="updatedTime" column="updated_time"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedBy" column="updated_by"/>
    </resultMap>

    <!-- 实例统计结果映射 -->
    <resultMap id="InstanceStatisticsResult" type="com.chennian.storytelling.bean.dto.InstanceStatisticsDTO">
        <result property="status" column="status"/>
        <result property="count" column="count"/>
        <result property="processDefinitionKey" column="process_definition_key"/>
        <result property="processDefinitionName" column="process_definition_name"/>
        <result property="startUserId" column="start_user_id"/>
        <result property="startUserName" column="start_user_name"/>
        <result property="startDeptId" column="start_dept_id"/>
        <result property="startDeptName" column="start_dept_name"/>
    </resultMap>

    <!-- 今日完成实例结果映射 -->
    <resultMap id="TodayCompletedInstanceResult" type="com.chennian.storytelling.bean.dto.TodayCompletedInstanceDTO">
        <result property="hour" column="hour"/>
        <result property="count" column="count"/>
        <result property="processDefinitionKey" column="process_definition_key"/>
        <result property="processDefinitionName" column="process_definition_name"/>
    </resultMap>

    <!-- 平均处理时间结果映射 -->
    <resultMap id="AverageProcessingTimeResult" type="com.chennian.storytelling.bean.dto.AverageProcessingTimeDTO">
        <result property="processDefinitionKey" column="process_definition_key"/>
        <result property="processDefinitionName" column="process_definition_name"/>
        <result property="averageDuration" column="average_duration"/>
        <result property="totalCount" column="total_count"/>
        <result property="completedCount" column="completed_count"/>
    </resultMap>

    <!-- 基础列字段 -->
    <sql id="Base_Column_List">
        id, instance_id, process_definition_id, process_definition_key, process_definition_name,
        process_definition_version, business_key, instance_name, instance_status, start_user_id,
        start_user_name, start_dept_id, start_dept_name, start_time, end_time, duration,
        suspension_state, priority, tenant_id, delete_reason, super_process_instance_id,
        root_process_instance_id, callback_id, callback_type, reference_id, reference_type,
        propagated_stage_instance_id, business_status, created_time, updated_time, created_by, updated_by
    </sql>

    <!-- 根据业务键查询实例 -->
    <select id="selectByBusinessKey" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE business_key = #{businessKey}
        AND deleted = 0
    </select>

    <!-- 根据流程定义ID查询实例列表 -->
    <select id="selectByProcessDefinitionId" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE process_definition_id = #{processDefinitionId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据流程定义键查询实例列表 -->
    <select id="selectByProcessDefinitionKey" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE process_definition_key = #{processDefinitionKey}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据实例状态查询实例列表 -->
    <select id="selectByInstanceStatus" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_status = #{instanceStatus}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据发起人ID查询实例列表 -->
    <select id="selectByStartUserId" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE start_user_id = #{startUserId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据发起部门ID查询实例列表 -->
    <select id="selectByStartDeptId" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE start_dept_id = #{startDeptId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据优先级查询实例列表 -->
    <select id="selectByPriority" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE priority = #{priority}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据租户ID查询实例列表 -->
    <select id="selectByTenantId" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE tenant_id = #{tenantId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询运行中的实例列表 -->
    <select id="selectRunningInstances" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_status = 'RUNNING'
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询已完成的实例列表 -->
    <select id="selectCompletedInstances" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_status = 'COMPLETED'
        <if test="processDefinitionId != null and processDefinitionId != ''">
            AND process_definition_id = #{processDefinitionId}
        </if>
        <if test="processDefinitionKey != null and processDefinitionKey != ''">
            AND process_definition_key = #{processDefinitionKey}
        </if>
        <if test="businessKey != null and businessKey != ''">
            AND business_key = #{businessKey}
        </if>
        <if test="startUserId != null and startUserId != ''">
            AND start_user_id = #{startUserId}
        </if>
        <if test="startDeptId != null and startDeptId != ''">
            AND start_dept_id = #{startDeptId}
        </if>
        <if test="tenantId != null and tenantId != ''">
            AND tenant_id = #{tenantId}
        </if>
        <if test="startTime != null">
            AND start_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND end_time <= #{endTime}
        </if>
        AND deleted = 0
        ORDER BY end_time DESC
    </select>

    <!-- 查询实例详情 -->
    <select id="selectInstanceDetail" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_id = #{instanceId}
        AND deleted = 0
    </select>

    <!-- 根据实例ID列表批量查询实例 -->
    <select id="selectByInstanceIds" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_id IN
        <foreach collection="instanceIds" item="instanceId" open="(" separator="," close=")">
            #{instanceId}
        </foreach>
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询实例统计信息 -->
    <select id="selectInstanceStatistics" resultType="java.util.Map">
        SELECT 
            instance_status as status,
            COUNT(*) as count,
            process_definition_key,
            process_definition_name
        FROM wf_instance
        WHERE deleted = 0
        <if test="processDefinitionKey != null and processDefinitionKey != ''">
            AND process_definition_key = #{processDefinitionKey}
        </if>
        <if test="startTime != null">
            AND start_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND start_time <= #{endTime}
        </if>
        GROUP BY instance_status, process_definition_key, process_definition_name
        ORDER BY count DESC
    </select>

    <!-- 查询超时实例 -->
    <select id="selectTimeoutInstances" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_status = 'RUNNING'
        AND TIMESTAMPDIFF(MINUTE, start_time, NOW()) > #{timeoutMinutes}
        AND deleted = 0
        ORDER BY start_time ASC
    </select>

    <!-- 更新实例状态 -->
    <update id="updateInstanceStatus">
        UPDATE wf_instance
        SET instance_status = #{status},
            updated_time = NOW(),
            updated_by = #{updatedBy}
        WHERE instance_id = #{instanceId}
        AND deleted = 0
    </update>

    <!-- 查询用户参与的实例 -->
    <select id="selectUserInstances" resultMap="WfInstanceResult">
        SELECT DISTINCT i.<include refid="Base_Column_List"/>
        FROM wf_instance i
        LEFT JOIN wf_task t ON i.instance_id = t.process_instance_id
        WHERE (i.start_user_id = #{userId} OR t.assignee = #{userId} OR FIND_IN_SET(#{userId}, t.candidate_users))
        <if test="status != null and status != ''">
            AND i.instance_status = #{status}
        </if>
        AND i.deleted = 0
        ORDER BY i.created_time DESC
    </select>

    <!-- 查询已挂起的实例列表 -->
    <select id="selectSuspendedInstances" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE suspension_state = 2
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询已终止的实例列表 -->
    <select id="selectTerminatedInstances" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_status = 'TERMINATED'
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据时间范围查询实例列表 -->
    <select id="selectByTimeRange" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE start_time >= #{startTime}
        AND start_time <= #{endTime}
        AND deleted = 0
        ORDER BY start_time DESC
    </select>

    <!-- 查询超时的实例列表 -->
    <select id="selectOverdueInstances" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_status = 'RUNNING'
        AND TIMESTAMPDIFF(HOUR, start_time, NOW()) > 24
        AND deleted = 0
        ORDER BY start_time ASC
    </select>

    <!-- 查询即将超时的实例列表 -->
    <select id="selectSoonOverdueInstances" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_status = 'RUNNING'
        AND TIMESTAMPDIFF(HOUR, start_time, NOW()) > (24 - #{hours})
        AND TIMESTAMPDIFF(HOUR, start_time, NOW()) <= 24
        AND deleted = 0
        ORDER BY start_time ASC
    </select>

    <!-- 根据实例名称模糊查询 -->
    <select id="selectByInstanceNameLike" resultMap="WfInstanceResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_instance
        WHERE instance_name LIKE CONCAT('%', #{instanceName}, '%')
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询实例统计信息 -->
    <select id="selectInstanceStatistics" resultMap="InstanceStatisticsResult">
        SELECT 
            instance_status as status,
            COUNT(*) as count
        FROM wf_instance
        WHERE deleted = 0
        GROUP BY instance_status
        ORDER BY count DESC
    </select>

    <!-- 根据状态统计实例数量 -->
    <select id="selectInstanceCountByStatus" resultMap="InstanceStatisticsResult">
        SELECT 
            instance_status as status,
            COUNT(*) as count
        FROM wf_instance
        WHERE deleted = 0
        GROUP BY instance_status
        ORDER BY count DESC
    </select>

    <!-- 根据流程定义统计实例数量 -->
    <select id="selectInstanceCountByProcessDefinition" resultMap="InstanceStatisticsResult">
        SELECT 
            process_definition_key,
            process_definition_name,
            COUNT(*) as count
        FROM wf_instance
        WHERE deleted = 0
        GROUP BY process_definition_key, process_definition_name
        ORDER BY count DESC
    </select>

    <!-- 根据发起人统计实例数量 -->
    <select id="selectInstanceCountByStartUser" resultMap="InstanceStatisticsResult">
        SELECT 
            start_user_id,
            start_user_name,
            COUNT(*) as count
        FROM wf_instance
        WHERE deleted = 0
        GROUP BY start_user_id, start_user_name
        ORDER BY count DESC
    </select>

    <!-- 根据部门统计实例数量 -->
    <select id="selectInstanceCountByDept" resultMap="InstanceStatisticsResult">
        SELECT 
            start_dept_id,
            start_dept_name,
            COUNT(*) as count
        FROM wf_instance
        WHERE deleted = 0
        GROUP BY start_dept_id, start_dept_name
        ORDER BY count DESC
    </select>

    <!-- 查询平均处理时长 -->
    <select id="selectAverageDuration" resultType="java.lang.Long">
        SELECT AVG(duration)
        FROM wf_instance
        WHERE instance_status = 'COMPLETED'
        AND duration IS NOT NULL
        AND deleted = 0
    </select>

    <!-- 根据流程定义查询平均处理时长 -->
    <select id="selectAverageDurationByProcessDefinition" resultType="java.lang.Long">
        SELECT AVG(duration)
        FROM wf_instance
        WHERE process_definition_key = #{processDefinitionKey}
        AND instance_status = 'COMPLETED'
        AND duration IS NOT NULL
        AND deleted = 0
    </select>

    <!-- 批量更新实例状态 -->
    <update id="batchUpdateInstanceStatus">
        UPDATE wf_instance
        SET instance_status = #{instanceStatus},
            updated_time = NOW(),
            updated_by = #{updatedBy}
        WHERE instance_id IN
        <foreach collection="instanceIds" item="instanceId" open="(" separator="," close=")">
            #{instanceId}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 查询今日完成的实例统计 -->
    <select id="selectTodayCompletedInstances" resultMap="TodayCompletedInstanceResult">
        SELECT 
            HOUR(end_time) as hour,
            COUNT(*) as count,
            process_definition_key,
            process_definition_name
        FROM wf_instance
        WHERE DATE(end_time) = CURDATE()
        AND instance_status = 'COMPLETED'
        AND deleted = 0
        GROUP BY HOUR(end_time), process_definition_key, process_definition_name
        ORDER BY hour
    </select>

    <!-- 查询平均处理时间统计 -->
    <select id="selectAverageProcessingTime" resultMap="AverageProcessingTimeResult">
        SELECT 
            process_definition_key,
            process_definition_name,
            AVG(duration) as average_duration,
            COUNT(*) as total_count,
            SUM(CASE WHEN instance_status = 'COMPLETED' THEN 1 ELSE 0 END) as completed_count
        FROM wf_instance
        WHERE deleted = 0
        GROUP BY process_definition_key, process_definition_name
        ORDER BY average_duration DESC
    </select>

</mapper>