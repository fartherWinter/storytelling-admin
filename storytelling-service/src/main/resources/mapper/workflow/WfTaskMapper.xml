<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.workflow.WfTaskMapper">

    <!-- 工作流任务结果映射 -->
    <resultMap id="WfTaskResult" type="com.chennian.storytelling.bean.model.workflow.WfTask">
        <id property="id" column="id"/>
        <result property="taskId" column="task_id"/>
        <result property="taskName" column="task_name"/>
        <result property="taskDefinitionKey" column="task_definition_key"/>
        <result property="processInstanceId" column="process_instance_id"/>
        <result property="processDefinitionId" column="process_definition_id"/>
        <result property="processDefinitionKey" column="process_definition_key"/>
        <result property="processDefinitionName" column="process_definition_name"/>
        <result property="executionId" column="execution_id"/>
        <result property="assignee" column="assignee"/>
        <result property="assigneeName" column="assignee_name"/>
        <result property="owner" column="owner"/>
        <result property="ownerName" column="owner_name"/>
        <result property="candidateUsers" column="candidate_users"/>
        <result property="candidateGroups" column="candidate_groups"/>
        <result property="delegationState" column="delegation_state"/>
        <result property="description" column="description"/>
        <result property="taskType" column="task_type"/>
        <result property="formKey" column="form_key"/>
        <result property="priority" column="priority"/>
        <result property="dueDate" column="due_date"/>
        <result property="followUpDate" column="follow_up_date"/>
        <result property="suspensionState" column="suspension_state"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="category" column="category"/>
        <result property="parentTaskId" column="parent_task_id"/>
        <result property="claimTime" column="claim_time"/>
        <result property="businessKey" column="business_key"/>
        <result property="taskStatus" column="task_status"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="duration" column="duration"/>
        <result property="deleteReason" column="delete_reason"/>
        <result property="createdTime" column="created_time"/>
        <result property="updatedTime" column="updated_time"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedBy" column="updated_by"/>
    </resultMap>

    <!-- 任务统计结果映射 -->
    <resultMap id="TaskStatisticsResult" type="com.chennian.storytelling.bean.dto.TaskStatisticsDTO">
        <result property="status" column="status"/>
        <result property="count" column="count"/>
        <result property="assignee" column="assignee"/>
        <result property="assigneeName" column="assignee_name"/>
        <result property="taskType" column="task_type"/>
        <result property="processDefinitionKey" column="process_definition_key"/>
        <result property="processDefinitionName" column="process_definition_name"/>
    </resultMap>

    <!-- 平均处理时间结果映射 -->
    <resultMap id="AverageProcessingTimeResult" type="com.chennian.storytelling.bean.dto.AverageProcessingTimeDTO">
        <result property="taskType" column="task_type"/>
        <result property="assignee" column="assignee"/>
        <result property="assigneeName" column="assignee_name"/>
        <result property="averageDuration" column="average_duration"/>
        <result property="totalCount" column="total_count"/>
        <result property="completedCount" column="completed_count"/>
    </resultMap>

    <!-- 基础列字段 -->
    <sql id="Base_Column_List">
        id, task_id, task_name, task_definition_key, process_instance_id, process_definition_id,
        process_definition_key, process_definition_name, execution_id, assignee, assignee_name,
        owner, owner_name, candidate_users, candidate_groups, delegation_state, description,
        task_type, form_key, priority, due_date, follow_up_date, suspension_state, tenant_id,
        category, parent_task_id, claim_time, business_key, task_status, start_time, end_time,
        duration, delete_reason, created_time, updated_time, created_by, updated_by
    </sql>

    <!-- 根据流程实例ID查询任务列表 -->
    <select id="selectByProcessInstanceId" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE process_instance_id = #{processInstanceId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据流程定义ID查询任务列表 -->
    <select id="selectByProcessDefinitionId" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE process_definition_id = #{processDefinitionId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据流程定义键查询任务列表 -->
    <select id="selectByProcessDefinitionKey" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE process_definition_key = #{processDefinitionKey}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据任务状态查询任务列表 -->
    <select id="selectByTaskStatus" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE task_status = #{taskStatus}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据分配人ID查询任务列表 -->
    <select id="selectByAssignee" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE assignee = #{assignee}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据候选人查询任务列表 -->
    <select id="selectByCandidateUser" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE FIND_IN_SET(#{candidateUser}, candidate_users)
        AND assignee IS NULL
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据候选组查询任务列表 -->
    <select id="selectByCandidateGroup" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE FIND_IN_SET(#{candidateGroup}, candidate_groups)
        AND assignee IS NULL
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据委托人ID查询任务列表 -->
    <select id="selectByOwner" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE owner = #{owner}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据任务类型查询任务列表 -->
    <select id="selectByTaskType" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE task_type = #{taskType}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据优先级查询任务列表 -->
    <select id="selectByPriority" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE priority = #{priority}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据租户ID查询任务列表 -->
    <select id="selectByTenantId" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE tenant_id = #{tenantId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据业务键查询任务列表 -->
    <select id="selectByBusinessKey" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE business_key = #{businessKey}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询待办任务列表 -->
    <select id="selectTodoTasks" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE (assignee = #{userId} OR FIND_IN_SET(#{userId}, candidate_users))
        AND task_status = 'ACTIVE'
        AND deleted = 0
        ORDER BY priority DESC, created_time ASC
    </select>

    <!-- 查询已办任务列表 -->
    <select id="selectDoneTasks" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE assignee = #{userId}
        AND task_status = 'COMPLETED'
        AND deleted = 0
        ORDER BY end_time DESC
    </select>

    <!-- 查询候选任务列表 -->
    <select id="selectCandidateTasks" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE FIND_IN_SET(#{userId}, candidate_users)
        AND assignee IS NULL
        AND task_status = 'ACTIVE'
        AND deleted = 0
        ORDER BY priority DESC, created_time ASC
    </select>

    <!-- 查询超时任务列表 -->
    <select id="selectOverdueTasks" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE due_date < NOW()
        AND task_status = 'ACTIVE'
        AND deleted = 0
        ORDER BY due_date ASC
    </select>

    <!-- 查询即将超时的任务列表 -->
    <select id="selectSoonOverdueTasks" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE due_date > NOW()
        AND due_date <= DATE_ADD(NOW(), INTERVAL #{hours} HOUR)
        AND task_status = 'ACTIVE'
        AND deleted = 0
        ORDER BY due_date ASC
    </select>

    <!-- 根据时间范围查询任务列表 -->
    <select id="selectByTimeRange" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE created_time >= #{startTime}
        AND created_time <= #{endTime}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 根据任务名称模糊查询 -->
    <select id="selectByTaskNameLike" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE task_name LIKE CONCAT('%', #{taskName}, '%')
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询任务统计信息 -->
    <select id="selectTaskStatistics" resultType="java.util.Map">
        SELECT 
            task_status as status,
            COUNT(*) as count
        FROM wf_task
        WHERE deleted = 0
        GROUP BY task_status
        ORDER BY count DESC
    </select>

    <!-- 根据状态统计任务数量 -->
    <select id="selectTaskCountByStatus" resultMap="TaskStatisticsResult">
        SELECT 
            task_status as status,
            COUNT(*) as count
        FROM wf_task
        WHERE deleted = 0
        GROUP BY task_status
        ORDER BY count DESC
    </select>

    <!-- 根据分配人统计任务数量 -->
    <select id="selectTaskCountByAssignee" resultMap="TaskStatisticsResult">
        SELECT 
            assignee,
            assignee_name,
            COUNT(*) as count
        FROM wf_task
        WHERE assignee IS NOT NULL
        AND deleted = 0
        GROUP BY assignee, assignee_name
        ORDER BY count DESC
    </select>

    <!-- 根据任务类型统计任务数量 -->
    <select id="selectTaskCountByType" resultMap="TaskStatisticsResult">
        SELECT 
            task_type,
            COUNT(*) as count
        FROM wf_task
        WHERE deleted = 0
        GROUP BY task_type
        ORDER BY count DESC
    </select>

    <!-- 根据流程定义统计任务数量 -->
    <select id="selectTaskCountByProcessDefinition" resultMap="TaskStatisticsResult">
        SELECT 
            process_definition_key,
            process_definition_name,
            COUNT(*) as count
        FROM wf_task
        WHERE deleted = 0
        GROUP BY process_definition_key, process_definition_name
        ORDER BY count DESC
    </select>

    <!-- 查询平均处理时长 -->
    <select id="selectAverageDuration" resultType="java.lang.Long">
        SELECT AVG(duration)
        FROM wf_task
        WHERE task_status = 'COMPLETED'
        AND duration IS NOT NULL
        AND deleted = 0
    </select>

    <!-- 根据任务类型查询平均处理时长 -->
    <select id="selectAverageDurationByTaskType" resultType="java.lang.Long">
        SELECT AVG(duration)
        FROM wf_task
        WHERE task_type = #{taskType}
        AND task_status = 'COMPLETED'
        AND duration IS NOT NULL
        AND deleted = 0
    </select>

    <!-- 根据分配人查询平均处理时长 -->
    <select id="selectAverageDurationByAssignee" resultType="java.lang.Long">
        SELECT AVG(duration)
        FROM wf_task
        WHERE assignee = #{assignee}
        AND task_status = 'COMPLETED'
        AND duration IS NOT NULL
        AND deleted = 0
    </select>

    <!-- 批量更新任务状态 -->
    <update id="batchUpdateTaskStatus">
        UPDATE wf_task
        SET task_status = #{taskStatus},
            updated_time = NOW(),
            updated_by = #{updatedBy}
        WHERE task_id IN
        <foreach collection="taskIds" item="taskId" open="(" separator="," close=")">
            #{taskId}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 批量分配任务 -->
    <update id="batchAssignTasks">
        UPDATE wf_task
        SET assignee = #{assignee},
            assignee_name = #{assigneeName},
            claim_time = NOW(),
            updated_time = NOW(),
            updated_by = #{updatedBy}
        WHERE task_id IN
        <foreach collection="taskIds" item="taskId" open="(" separator="," close=")">
            #{taskId}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 查询待处理任务统计 -->
    <select id="selectPendingTaskStatistics" resultType="java.util.Map">
        SELECT 
            assignee,
            assignee_name,
            COUNT(*) as pending_count,
            COUNT(CASE WHEN due_date < NOW() THEN 1 END) as overdue_count
        FROM wf_task
        WHERE task_status = 'ACTIVE'
        AND assignee IS NOT NULL
        AND deleted = 0
        GROUP BY assignee, assignee_name
        ORDER BY pending_count DESC
    </select>

    <!-- 查询最近任务列表 -->
    <select id="selectRecentTasks" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE (assignee = #{userId} OR FIND_IN_SET(#{userId}, candidate_users))
        AND deleted = 0
        ORDER BY updated_time DESC
        LIMIT #{limit}
    </select>

    <!-- 查询任务详情 -->
    <select id="selectTaskDetail" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE task_id = #{taskId}
        AND deleted = 0
    </select>

    <!-- 根据任务ID列表批量查询任务 -->
    <select id="selectByTaskIds" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE task_id IN
        <foreach collection="taskIds" item="taskId" open="(" separator="," close=")">
            #{taskId}
        </foreach>
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询用户任务历史 -->
    <select id="selectUserTaskHistory" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE assignee = #{userId}
        <if test="processDefinitionKey != null and processDefinitionKey != ''">
            AND process_definition_key = #{processDefinitionKey}
        </if>
        <if test="taskType != null and taskType != ''">
            AND task_type = #{taskType}
        </if>
        <if test="startTime != null">
            AND start_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND end_time <= #{endTime}
        </if>
        AND deleted = 0
        ORDER BY end_time DESC
    </select>

    <!-- 查询任务处理时长统计 -->
    <select id="selectTaskDurationStatistics" resultType="java.util.Map">
        SELECT 
            task_type,
            COUNT(*) as total_count,
            AVG(duration) as avg_duration,
            MIN(duration) as min_duration,
            MAX(duration) as max_duration
        FROM wf_task
        WHERE task_status = 'COMPLETED'
        AND duration IS NOT NULL
        AND deleted = 0
        GROUP BY task_type
        ORDER BY avg_duration DESC
    </select>

    <!-- 更新任务优先级 -->
    <update id="updateTaskPriority">
        UPDATE wf_task
        SET priority = #{priority},
            updated_time = NOW(),
            updated_by = #{updatedBy}
        WHERE task_id = #{taskId}
        AND deleted = 0
    </update>

    <!-- 查询委托任务 -->
    <select id="selectDelegatedTasks" resultMap="WfTaskResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_task
        WHERE owner = #{userId}
        AND delegation_state = 'PENDING'
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 查询任务执行路径 -->
    <select id="selectTaskExecutionPath" resultType="java.util.Map">
        SELECT 
            task_id,
            task_name,
            assignee,
            assignee_name,
            start_time,
            end_time,
            duration,
            task_status
        FROM wf_task
        WHERE process_instance_id = #{processInstanceId}
        AND deleted = 0
        ORDER BY start_time ASC
    </select>

</mapper>