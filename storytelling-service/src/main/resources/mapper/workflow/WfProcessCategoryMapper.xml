<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.workflow.WfProcessCategoryMapper">

    <!-- 工作流流程分类结果映射 -->
    <resultMap id="WfProcessCategoryResult" type="com.chennian.storytelling.bean.model.workflow.WfProcessCategory">
        <id property="id" column="id"/>
        <result property="categoryCode" column="category_code"/>
        <result property="categoryName" column="category_name"/>
        <result property="parentId" column="parent_id"/>
        <result property="level" column="level"/>
        <result property="path" column="path"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="icon" column="icon"/>
        <result property="color" column="color"/>
        <result property="enabled" column="enabled"/>
        <result property="description" column="description"/>
        <result property="metadata" column="metadata"/>
        <result property="permissions" column="permissions"/>
        <result property="tags" column="tags"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdTime" column="created_time"/>
        <result property="updatedBy" column="updated_by"/>
        <result property="updatedTime" column="updated_time"/>
        <result property="version" column="version"/>
        <result property="childCount" column="child_count"/>
        <result property="processCount" column="process_count"/>
    </resultMap>

    <!-- 分类统计结果映射 -->
    <resultMap id="CategoryStatisticsResult" type="com.chennian.storytelling.bean.dto.CategoryStatisticsDTO">
        <result property="categoryId" column="category_id"/>
        <result property="categoryCode" column="category_code"/>
        <result property="categoryName" column="category_name"/>
        <result property="level" column="level"/>
        <result property="childCount" column="child_count"/>
        <result property="processCount" column="process_count"/>
        <result property="enabledCount" column="enabled_count"/>
        <result property="totalCount" column="total_count"/>
    </resultMap>

    <!-- 分类层级路径结果映射 -->
    <resultMap id="CategoryPathResult" type="com.chennian.storytelling.bean.dto.CategoryPathDTO">
        <result property="categoryId" column="category_id"/>
        <result property="categoryCode" column="category_code"/>
        <result property="categoryName" column="category_name"/>
        <result property="level" column="level"/>
        <result property="path" column="path"/>
        <result property="fullPath" column="full_path"/>
    </resultMap>

    <!-- 基础列字段 -->
    <sql id="Base_Column_List">
        id, category_code, category_name, parent_id, level, path, sort_order, icon, color,
        enabled, description, metadata, permissions, tags, tenant_id, created_by, created_time,
        updated_by, updated_time, version, child_count, process_count
    </sql>

    <!-- 根据分类编码查询分类 -->
    <select id="selectByCategoryCode" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE category_code = #{categoryCode}
        AND deleted = 0
    </select>

    <!-- 根据父分类ID查询子分类列表 -->
    <select id="selectByParentId" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE parent_id = #{parentId}
        AND deleted = 0
        ORDER BY sort_order ASC, created_time ASC
    </select>

    <!-- 根据启用状态查询分类列表 -->
    <select id="selectByEnabled" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE enabled = #{enabled}
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 根据分类名称模糊查询 -->
    <select id="selectByCategoryNameLike" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE category_name LIKE CONCAT('%', #{categoryName}, '%')
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 查询所有根分类 -->
    <select id="selectRootCategories" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE parent_id IS NULL OR parent_id = 0
        AND deleted = 0
        ORDER BY sort_order ASC, created_time ASC
    </select>

    <!-- 查询分类树形结构 -->
    <select id="selectCategoryTree" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE deleted = 0
        <if test="enabled != null">
            AND enabled = #{enabled}
        </if>
        <if test="tenantId != null and tenantId != ''">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 检查分类编码是否存在 -->
    <select id="existsByCategoryCode" resultType="boolean">
        SELECT COUNT(1) > 0
        FROM wf_process_category
        WHERE category_code = #{categoryCode}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
        AND deleted = 0
    </select>

    <!-- 检查分类名称是否存在 -->
    <select id="existsByCategoryName" resultType="boolean">
        SELECT COUNT(1) > 0
        FROM wf_process_category
        WHERE category_name = #{categoryName}
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
        AND deleted = 0
    </select>

    <!-- 查询分类下子分类数量 -->
    <select id="selectChildCategoryCount" resultType="int">
        SELECT COUNT(*)
        FROM wf_process_category
        WHERE parent_id = #{categoryId}
        AND deleted = 0
    </select>

    <!-- 查询分类下流程定义数量 -->
    <select id="selectProcessDefinitionCount" resultType="int">
        SELECT COUNT(*)
        FROM wf_process_definition
        WHERE category_id = #{categoryId}
        AND deleted = 0
    </select>

    <!-- 批量更新分类状态 -->
    <update id="batchUpdateCategoryStatus">
        UPDATE wf_process_category
        SET enabled = #{enabled},
            updated_time = NOW(),
            updated_by = #{updatedBy}
        WHERE id IN
        <foreach collection="categoryIds" item="categoryId" open="(" separator="," close=")">
            #{categoryId}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 查询分类统计信息 -->
    <select id="selectCategoryStatistics" resultType="java.util.Map">
        SELECT 
            pc.id as category_id,
            pc.category_code,
            pc.category_name,
            pc.level,
            COUNT(DISTINCT child.id) as child_count,
            COUNT(DISTINCT pd.id) as process_count,
            SUM(CASE WHEN child.enabled = 1 THEN 1 ELSE 0 END) as enabled_child_count,
            SUM(CASE WHEN pd.enabled = 1 THEN 1 ELSE 0 END) as enabled_process_count
        FROM wf_process_category pc
        LEFT JOIN wf_process_category child ON pc.id = child.parent_id AND child.deleted = 0
        LEFT JOIN wf_process_definition pd ON pc.id = pd.category_id AND pd.deleted = 0
        WHERE pc.deleted = 0
        GROUP BY pc.id, pc.category_code, pc.category_name, pc.level
        ORDER BY pc.level ASC, pc.sort_order ASC
    </select>

    <!-- 查询分类详情 -->
    <select id="selectCategoryDetail" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE id = #{categoryId}
        AND deleted = 0
    </select>

    <!-- 根据分类ID列表批量查询分类 -->
    <select id="selectByCategoryIds" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE id IN
        <foreach collection="categoryIds" item="categoryId" open="(" separator="," close=")">
            #{categoryId}
        </foreach>
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 查询分类层级路径 -->
    <select id="selectCategoryPath" resultMap="CategoryPathResult">
        WITH RECURSIVE category_path AS (
            SELECT 
                id as category_id,
                category_code,
                category_name,
                level,
                path,
                category_name as full_path
            FROM wf_process_category
            WHERE id = #{categoryId}
            AND deleted = 0
            
            UNION ALL
            
            SELECT 
                cp.category_id,
                cp.category_code,
                cp.category_name,
                cp.level,
                cp.path,
                CONCAT(pc.category_name, ' > ', cp.full_path) as full_path
            FROM category_path cp
            JOIN wf_process_category pc ON cp.path LIKE CONCAT('%/', pc.id, '/%')
            WHERE pc.deleted = 0
        )
        SELECT * FROM category_path
        ORDER BY level DESC
        LIMIT 1
    </select>

    <!-- 查询所有叶子分类 -->
    <select id="selectLeafCategories" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category pc
        WHERE pc.deleted = 0
        AND NOT EXISTS (
            SELECT 1 FROM wf_process_category child
            WHERE child.parent_id = pc.id
            AND child.deleted = 0
        )
        <if test="enabled != null">
            AND pc.enabled = #{enabled}
        </if>
        ORDER BY pc.level ASC, pc.sort_order ASC, pc.created_time ASC
    </select>

    <!-- 根据层级查询分类列表 -->
    <select id="selectByLevel" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE level = #{level}
        AND deleted = 0
        ORDER BY sort_order ASC, created_time ASC
    </select>

    <!-- 根据路径查询分类列表 -->
    <select id="selectByPath" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE path LIKE CONCAT(#{path}, '%')
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 根据标签查询分类列表 -->
    <select id="selectByTags" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE FIND_IN_SET(#{tag}, tags)
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 根据租户ID查询分类列表 -->
    <select id="selectByTenantId" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE tenant_id = #{tenantId}
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 查询分类的所有祖先分类 -->
    <select id="selectAncestorCategories" resultMap="WfProcessCategoryResult">
        WITH RECURSIVE ancestor_categories AS (
            SELECT <include refid="Base_Column_List"/>
            FROM wf_process_category
            WHERE id = #{categoryId}
            AND deleted = 0
            
            UNION ALL
            
            SELECT pc.<include refid="Base_Column_List"/>
            FROM wf_process_category pc
            JOIN ancestor_categories ac ON pc.id = ac.parent_id
            WHERE pc.deleted = 0
        )
        SELECT * FROM ancestor_categories
        WHERE id != #{categoryId}
        ORDER BY level ASC
    </select>

    <!-- 查询分类的所有后代分类 -->
    <select id="selectDescendantCategories" resultMap="WfProcessCategoryResult">
        WITH RECURSIVE descendant_categories AS (
            SELECT <include refid="Base_Column_List"/>
            FROM wf_process_category
            WHERE id = #{categoryId}
            AND deleted = 0
            
            UNION ALL
            
            SELECT pc.<include refid="Base_Column_List"/>
            FROM wf_process_category pc
            JOIN descendant_categories dc ON pc.parent_id = dc.id
            WHERE pc.deleted = 0
        )
        SELECT * FROM descendant_categories
        WHERE id != #{categoryId}
        ORDER BY level ASC, sort_order ASC
    </select>

    <!-- 查询同级分类 -->
    <select id="selectSiblingCategories" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE parent_id = (
            SELECT parent_id FROM wf_process_category
            WHERE id = #{categoryId} AND deleted = 0
        )
        AND id != #{categoryId}
        AND deleted = 0
        ORDER BY sort_order ASC, created_time ASC
    </select>

    <!-- 更新分类子分类数量 -->
    <update id="updateChildCategoryCount">
        UPDATE wf_process_category
        SET child_count = (
            SELECT COUNT(*)
            FROM wf_process_category child
            WHERE child.parent_id = wf_process_category.id
            AND child.deleted = 0
        ),
        updated_time = NOW()
        WHERE id = #{categoryId}
        AND deleted = 0
    </update>

    <!-- 更新分类流程定义数量 -->
    <update id="updateProcessDefinitionCount">
        UPDATE wf_process_category
        SET process_count = (
            SELECT COUNT(*)
            FROM wf_process_definition pd
            WHERE pd.category_id = wf_process_category.id
            AND pd.deleted = 0
        ),
        updated_time = NOW()
        WHERE id = #{categoryId}
        AND deleted = 0
    </update>

    <!-- 根据排序顺序查询分类列表 -->
    <select id="selectBySortOrder" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE deleted = 0
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        ORDER BY sort_order ASC, created_time ASC
    </select>

    <!-- 查询最大排序顺序 -->
    <select id="selectMaxSortOrder" resultType="int">
        SELECT COALESCE(MAX(sort_order), 0)
        FROM wf_process_category
        WHERE deleted = 0
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
    </select>

    <!-- 根据图标查询分类列表 -->
    <select id="selectByIcon" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE icon = #{icon}
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 根据颜色查询分类列表 -->
    <select id="selectByColor" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE color = #{color}
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 查询有权限的分类列表 -->
    <select id="selectCategoriesWithPermissions" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE permissions IS NOT NULL
        AND permissions != ''
        AND enabled = 1
        AND deleted = 0
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

    <!-- 复合条件查询分类列表 -->
    <select id="selectByConditions" resultMap="WfProcessCategoryResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_process_category
        WHERE deleted = 0
        <if test="categoryCode != null and categoryCode != ''">
            AND category_code = #{categoryCode}
        </if>
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="enabled != null">
            AND enabled = #{enabled}
        </if>
        <if test="categoryName != null and categoryName != ''">
            AND category_name LIKE CONCAT('%', #{categoryName}, '%')
        </if>
        <if test="level != null">
            AND level = #{level}
        </if>
        <if test="tenantId != null and tenantId != ''">
            AND tenant_id = #{tenantId}
        </if>
        <if test="icon != null and icon != ''">
            AND icon = #{icon}
        </if>
        <if test="color != null and color != ''">
            AND color = #{color}
        </if>
        ORDER BY level ASC, sort_order ASC, created_time ASC
    </select>

</mapper>