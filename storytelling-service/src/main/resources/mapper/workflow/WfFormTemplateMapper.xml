<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.workflow.WfFormTemplateMapper">

    <!-- 工作流表单模板结果映射 -->
    <resultMap id="WfFormTemplateResult" type="com.chennian.storytelling.bean.model.workflow.WfFormTemplate">
        <id property="id" column="id"/>
        <result property="formId" column="form_id"/>
        <result property="formName" column="form_name"/>
        <result property="formDescription" column="form_description"/>
        <result property="processKey" column="process_key"/>
        <result property="version" column="version"/>
        <result property="formConfig" column="form_config"/>
        <result property="formFields" column="form_fields"/>
        <result property="formLayout" column="form_layout"/>
        <result property="formRules" column="form_rules"/>
        <result property="category" column="category"/>
        <result property="enabled" column="enabled"/>
        <result property="isPublic" column="is_public"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="remark" column="remark"/>
        <result property="creatorId" column="creator_id"/>
        <result property="creatorName" column="creator_name"/>
        <result property="createdTime" column="created_time"/>
        <result property="updaterId" column="updater_id"/>
        <result property="updaterName" column="updater_name"/>
        <result property="updatedTime" column="updated_time"/>
        <result property="deleted" column="deleted"/>
        <result property="tenantId" column="tenant_id"/>
    </resultMap>

    <!-- 基础字段列表 -->
    <sql id="Base_Column_List">
        id, form_id, form_name, form_description, process_key, version,
        form_config, form_fields, form_layout, form_rules, category,
        enabled, is_public, sort_order, remark, creator_id, creator_name,
        created_time, updater_id, updater_name, updated_time, deleted, tenant_id
    </sql>

    <!-- 根据表单ID查询表单模板 -->
    <select id="selectByFormId" resultMap="WfFormTemplateResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_form_template
        WHERE form_id = #{formId}
        AND deleted = 0
        ORDER BY version DESC
        LIMIT 1
    </select>

    <!-- 根据流程键查询表单模板列表 -->
    <select id="selectByProcessKey" resultMap="WfFormTemplateResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_form_template
        WHERE process_key = #{processKey}
        AND deleted = 0
        AND enabled = 1
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 根据分类查询表单模板列表 -->
    <select id="selectByCategory" resultMap="WfFormTemplateResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_form_template
        WHERE category = #{category}
        AND deleted = 0
        AND enabled = 1
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 查询启用的表单模板列表 -->
    <select id="selectEnabledTemplates" resultMap="WfFormTemplateResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_form_template
        WHERE enabled = 1
        AND deleted = 0
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 查询公开的表单模板列表 -->
    <select id="selectPublicTemplates" resultMap="WfFormTemplateResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_form_template
        WHERE is_public = 1
        AND enabled = 1
        AND deleted = 0
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 根据创建者查询表单模板列表 -->
    <select id="selectByCreator" resultMap="WfFormTemplateResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_form_template
        WHERE creator_id = #{creatorId}
        AND deleted = 0
        ORDER BY created_time DESC
    </select>

    <!-- 检查表单ID是否存在 -->
    <select id="checkFormIdExists" resultType="int">
        SELECT COUNT(1)
        FROM wf_form_template
        WHERE form_id = #{formId}
        AND deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 获取表单模板的最大版本号 -->
    <select id="getMaxVersion" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(version), 0)
        FROM wf_form_template
        WHERE form_id = #{formId}
        AND deleted = 0
    </select>

    <!-- 批量更新状态 -->
    <update id="batchUpdateStatus">
        UPDATE wf_form_template
        SET enabled = #{enabled},
            updater_id = #{updaterId},
            updater_name = #{updaterName},
            updated_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 复制表单模板 -->
    <insert id="copyFormTemplate" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO wf_form_template (
            form_id, form_name, form_description, process_key, version,
            form_config, form_fields, form_layout, form_rules, category,
            enabled, is_public, sort_order, remark,
            creator_id, creator_name, created_time,
            updater_id, updater_name, updated_time,
            deleted, tenant_id
        )
        SELECT 
            #{newFormId}, #{newFormName}, form_description, process_key, 1,
            form_config, form_fields, form_layout, form_rules, category,
            enabled, is_public, sort_order, remark,
            #{creatorId}, #{creatorName}, NOW(),
            #{creatorId}, #{creatorName}, NOW(),
            0, tenant_id
        FROM wf_form_template
        WHERE id = #{sourceId}
        AND deleted = 0
    </insert>

    <!-- 根据条件查询表单模板列表（分页） -->
    <select id="selectFormTemplateList" resultMap="WfFormTemplateResult">
        SELECT <include refid="Base_Column_List"/>
        FROM wf_form_template
        WHERE deleted = 0
        <if test="formName != null and formName != ''">
            AND form_name LIKE CONCAT('%', #{formName}, '%')
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="processKey != null and processKey != ''">
            AND process_key = #{processKey}
        </if>
        <if test="enabled != null">
            AND enabled = #{enabled}
        </if>
        <if test="isPublic != null">
            AND is_public = #{isPublic}
        </if>
        <if test="creatorId != null">
            AND creator_id = #{creatorId}
        </if>
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 获取表单模板统计信息 -->
    <select id="getFormTemplateStats" resultType="java.util.Map">
        SELECT 
            COUNT(1) as total,
            SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count,
            SUM(CASE WHEN enabled = 0 THEN 1 ELSE 0 END) as disabled_count,
            SUM(CASE WHEN is_public = 1 THEN 1 ELSE 0 END) as public_count,
            SUM(CASE WHEN is_public = 0 THEN 1 ELSE 0 END) as private_count,
            COUNT(DISTINCT category) as category_count,
            COUNT(DISTINCT process_key) as process_count
        FROM wf_form_template
        WHERE deleted = 0
    </select>

</mapper>