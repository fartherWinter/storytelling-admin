<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chennian.storytelling.dao.SysPermissionMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.chennian.storytelling.bean.model.SysPermission">
        <id column="permission_id" property="permissionId" />
        <result column="permission_name" property="permissionName" />
        <result column="permission_code" property="permissionCode" />
        <result column="permission_type" property="permissionType" />
        <result column="resource_url" property="resourceUrl" />
        <result column="parent_id" property="parentId" />
        <result column="sort_order" property="sortOrder" />
        <result column="status" property="status" />
        <result column="create_by" property="createBy" />
        <result column="create_time" property="createTime" />
        <result column="update_by" property="updateBy" />
        <result column="update_time" property="updateTime" />
        <result column="remark" property="remark" />
        <result column="icon" property="icon" />
        <result column="is_frame" property="isFrame" />
        <result column="is_cache" property="isCache" />
        <result column="visible" property="visible" />
        <result column="component" property="component" />
        <result column="query" property="query" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        permission_id, permission_name, permission_code, permission_type, resource_url, 
        parent_id, sort_order, status, create_by, create_time, update_by, update_time, 
        remark, icon, is_frame, is_cache, visible, component, query
    </sql>

    <!-- 查询权限列表 -->
    <select id="selectPermissionList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        <where>
            <if test="permissionType != null and permissionType != ''">
                AND permission_type = #{permissionType}
            </if>
            AND status = '0'
        </where>
        ORDER BY sort_order ASC
    </select>

    <!-- 根据权限ID查询权限信息 -->
    <select id="selectPermissionById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE permission_id = #{permissionId}
    </select>

    <!-- 根据角色ID查询权限列表 -->
    <select id="selectPermissionsByRoleId" resultMap="BaseResultMap">
        SELECT p.<include refid="Base_Column_List" />
        FROM sys_permission p
        INNER JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
        WHERE rp.role_id = #{roleId}
        AND p.status = '0'
        ORDER BY p.sort_order ASC
    </select>

    <!-- 根据用户ID查询权限编码列表 -->
    <select id="selectPermissionCodesByUserId" resultType="java.lang.String">
        SELECT DISTINCT p.permission_code
        FROM sys_permission p
        INNER JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND p.status = '0'
        AND ur.enabled = 1
    </select>

    <!-- 检查用户是否有指定权限 -->
    <select id="checkUserPermission" resultType="int">
        SELECT COUNT(1)
        FROM sys_permission p
        INNER JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND p.permission_code = #{permissionCode}
        AND p.status = '0'
        AND ur.enabled = 1
    </select>

    <!-- 查询工作流权限列表 -->
    <select id="selectWorkflowPermissions" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE permission_type = 'WORKFLOW'
        AND status = '0'
        ORDER BY sort_order ASC
    </select>

    <!-- 新增权限信息 -->
    <insert id="insertPermission" parameterType="com.chennian.storytelling.bean.model.SysPermission" useGeneratedKeys="true" keyProperty="permissionId">
        INSERT INTO sys_permission
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="permissionName != null and permissionName != ''">permission_name,</if>
            <if test="permissionCode != null and permissionCode != ''">permission_code,</if>
            <if test="permissionType != null and permissionType != ''">permission_type,</if>
            <if test="resourceUrl != null">resource_url,</if>
            <if test="parentId != null">parent_id,</if>
            <if test="sortOrder != null">sort_order,</if>
            <if test="status != null">status,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="remark != null">remark,</if>
            <if test="icon != null">icon,</if>
            <if test="isFrame != null">is_frame,</if>
            <if test="isCache != null">is_cache,</if>
            <if test="visible != null">visible,</if>
            <if test="component != null">component,</if>
            <if test="query != null">query,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="permissionName != null and permissionName != ''">#{permissionName},</if>
            <if test="permissionCode != null and permissionCode != ''">#{permissionCode},</if>
            <if test="permissionType != null and permissionType != ''">#{permissionType},</if>
            <if test="resourceUrl != null">#{resourceUrl},</if>
            <if test="parentId != null">#{parentId},</if>
            <if test="sortOrder != null">#{sortOrder},</if>
            <if test="status != null">#{status},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="remark != null">#{remark},</if>
            <if test="icon != null">#{icon},</if>
            <if test="isFrame != null">#{isFrame},</if>
            <if test="isCache != null">#{isCache},</if>
            <if test="visible != null">#{visible},</if>
            <if test="component != null">#{component},</if>
            <if test="query != null">#{query},</if>
        </trim>
    </insert>

    <!-- 修改权限信息 -->
    <update id="updatePermission" parameterType="com.chennian.storytelling.bean.model.SysPermission">
        UPDATE sys_permission
        <trim prefix="SET" suffixOverrides=",">
            <if test="permissionName != null and permissionName != ''">permission_name = #{permissionName},</if>
            <if test="permissionCode != null and permissionCode != ''">permission_code = #{permissionCode},</if>
            <if test="permissionType != null and permissionType != ''">permission_type = #{permissionType},</if>
            <if test="resourceUrl != null">resource_url = #{resourceUrl},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="status != null">status = #{status},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="icon != null">icon = #{icon},</if>
            <if test="isFrame != null">is_frame = #{isFrame},</if>
            <if test="isCache != null">is_cache = #{isCache},</if>
            <if test="visible != null">visible = #{visible},</if>
            <if test="component != null">component = #{component},</if>
            <if test="query != null">query = #{query},</if>
        </trim>
        WHERE permission_id = #{permissionId}
    </update>

    <!-- 删除权限信息 -->
    <delete id="deletePermissionById">
        DELETE FROM sys_permission WHERE permission_id = #{permissionId}
    </delete>

    <!-- 批量删除权限信息 -->
    <delete id="deletePermissionByIds">
        DELETE FROM sys_permission WHERE permission_id IN
        <foreach item="permissionId" collection="permissionIds" open="(" separator="," close=")">
            #{permissionId}
        </foreach>
    </delete>

    <!-- 校验权限编码是否唯一 -->
    <select id="checkPermissionCodeUnique" resultType="int">
        SELECT COUNT(1) FROM sys_permission
        WHERE permission_code = #{permissionCode}
        <if test="permissionId != null">
            AND permission_id != #{permissionId}
        </if>
    </select>

    <!-- 统计子权限数量 -->
    <select id="countChildPermissions" resultType="int">
        SELECT COUNT(1) FROM sys_permission WHERE parent_id = #{permissionId}
    </select>

    <!-- 根据父权限ID查询子权限列表 -->
    <select id="selectPermissionsByParentId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE parent_id = #{parentId}
        AND status = '0'
        ORDER BY sort_order ASC
    </select>

    <!-- 查询所有权限（用于构建权限树） -->
    <select id="selectAllPermissions" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE status = '0'
        ORDER BY sort_order ASC
    </select>

    <!-- 根据权限编码查询权限信息 -->
    <select id="selectPermissionByCode" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE permission_code = #{permissionCode}
        AND status = '0'
    </select>

    <!-- 根据权限类型和状态查询权限列表 -->
    <select id="selectPermissionsByTypeAndStatus" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        <where>
            <if test="permissionType != null and permissionType != ''">permission_type = #{permissionType}</if>
            <if test="status != null and status != ''">AND status = #{status}</if>
        </where>
        ORDER BY sort_order ASC
    </select>

    <!-- 查询用户的菜单权限 -->
    <select id="selectMenuPermissionsByUserId" resultMap="BaseResultMap">
        SELECT DISTINCT p.<include refid="Base_Column_List" />
        FROM sys_permission p
        INNER JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND p.permission_type = 'MENU'
        AND p.status = '0'
        AND ur.enabled = 1
        ORDER BY p.sort_order ASC
    </select>

    <!-- 查询用户的按钮权限 -->
    <select id="selectButtonPermissionsByUserId" resultMap="BaseResultMap">
        SELECT DISTINCT p.<include refid="Base_Column_List" />
        FROM sys_permission p
        INNER JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND p.permission_type = 'BUTTON'
        AND p.status = '0'
        AND ur.enabled = 1
        ORDER BY p.sort_order ASC
    </select>

    <!-- 查询用户的API权限 -->
    <select id="selectApiPermissionsByUserId" resultMap="BaseResultMap">
        SELECT DISTINCT p.<include refid="Base_Column_List" />
        FROM sys_permission p
        INNER JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND p.permission_type = 'API'
        AND p.status = '0'
        AND ur.enabled = 1
        ORDER BY p.sort_order ASC
    </select>

    <!-- 查询用户的工作流权限 -->
    <select id="selectWorkflowPermissionsByUserId" resultMap="BaseResultMap">
        SELECT DISTINCT p.<include refid="Base_Column_List" />
        FROM sys_permission p
        INNER JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND p.permission_type = 'WORKFLOW'
        AND p.status = '0'
        AND ur.enabled = 1
        ORDER BY p.sort_order ASC
    </select>

    <!-- 根据资源URL查询权限信息 -->
    <select id="selectPermissionsByResourceUrl" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE resource_url = #{resourceUrl}
        AND status = '0'
        ORDER BY sort_order ASC
    </select>

    <!-- 批量插入权限信息 -->
    <insert id="batchInsertPermissions">
        INSERT INTO sys_permission (permission_name, permission_code, permission_type, resource_url, 
        parent_id, sort_order, status, create_by, create_time, remark, icon, is_frame, is_cache, visible, component, query)
        VALUES
        <foreach collection="permissions" item="permission" separator=",">
            (#{permission.permissionName}, #{permission.permissionCode}, #{permission.permissionType}, 
            #{permission.resourceUrl}, #{permission.parentId}, #{permission.sortOrder}, #{permission.status}, 
            #{permission.createBy}, #{permission.createTime}, #{permission.remark}, #{permission.icon}, 
            #{permission.isFrame}, #{permission.isCache}, #{permission.visible}, #{permission.component}, #{permission.query})
        </foreach>
    </insert>

    <!-- 批量更新权限状态 -->
    <update id="batchUpdatePermissionStatus">
        UPDATE sys_permission
        SET status = #{status}, update_by = #{updateBy}, update_time = NOW()
        WHERE permission_id IN
        <foreach collection="permissionIds" item="permissionId" open="(" separator="," close=")">
            #{permissionId}
        </foreach>
    </update>

    <!-- 查询权限统计信息 -->
    <select id="selectPermissionStatistics" resultType="java.util.Map">
        SELECT 
            permission_type AS type,
            COUNT(*) AS count
        FROM sys_permission
        WHERE status = '0'
        GROUP BY permission_type
    </select>

    <!-- 根据权限名称模糊查询 -->
    <select id="selectPermissionsByNameLike" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE permission_name LIKE CONCAT('%', #{permissionName}, '%')
        AND status = '0'
        ORDER BY sort_order ASC
    </select>

    <!-- 根据权限编码模糊查询 -->
    <select id="selectPermissionsByCodeLike" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM sys_permission
        WHERE permission_code LIKE CONCAT('%', #{permissionCode}, '%')
        AND status = '0'
        ORDER BY sort_order ASC
    </select>

    <!-- 查询最大排序值 -->
    <select id="selectMaxSortOrder" resultType="java.lang.Integer">
        SELECT IFNULL(MAX(sort_order), 0) FROM sys_permission
        <where>
            <if test="parentId != null">parent_id = #{parentId}</if>
            <if test="parentId == null">parent_id IS NULL</if>
        </where>
    </select>

    <!-- 更新权限排序 -->
    <update id="updatePermissionSortOrder">
        UPDATE sys_permission
        SET sort_order = #{sortOrder}
        WHERE permission_id = #{permissionId}
    </update>

    <!-- 查询权限路径（从根到当前权限的完整路径） -->
    <select id="selectPermissionPath" resultMap="BaseResultMap">
        WITH RECURSIVE permission_path AS (
            SELECT permission_id, permission_name, permission_code, parent_id, 0 as level
            FROM sys_permission
            WHERE permission_id = #{permissionId}
            
            UNION ALL
            
            SELECT p.permission_id, p.permission_name, p.permission_code, p.parent_id, pp.level + 1
            FROM sys_permission p
            INNER JOIN permission_path pp ON p.permission_id = pp.parent_id
        )
        SELECT permission_id, permission_name, permission_code, parent_id
        FROM permission_path
        ORDER BY level DESC
    </select>

</mapper>