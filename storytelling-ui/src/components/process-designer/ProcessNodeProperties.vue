<template>
  <div class="process-node-properties">
    <el-form :model="nodeData" label-width="80px" size="small">
      <!-- Âü∫Á°Ä‰ø°ÊÅØ -->
      <el-card class="property-card" shadow="never">
        <template #header>
          <span class="card-title">üìù Âü∫Á°Ä‰ø°ÊÅØ</span>
        </template>
        
        <el-form-item label="ËäÇÁÇπID">
          <el-input v-model="nodeData.id" disabled />
        </el-form-item>
        
        <el-form-item label="ËäÇÁÇπÂêçÁß∞">
          <el-input 
            v-model="nodeData.name" 
            placeholder="ËØ∑ËæìÂÖ•ËäÇÁÇπÂêçÁß∞"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="ËäÇÁÇπÁ±ªÂûã">
          <el-tag :type="getNodeTypeColor(nodeData.type)">
            {{ getNodeTypeName(nodeData.type) }}
          </el-tag>
        </el-form-item>
        
        <el-form-item label="ÊèèËø∞">
          <el-input 
            v-model="nodeData.description" 
            type="textarea" 
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•ËäÇÁÇπÊèèËø∞"
            @input="handleUpdate"
          />
        </el-form-item>
      </el-card>
      
      <!-- ‰ΩçÁΩÆ‰ø°ÊÅØ -->
      <el-card class="property-card" shadow="never">
        <template #header>
          <span class="card-title">üìç ‰ΩçÁΩÆ‰ø°ÊÅØ</span>
        </template>
        
        <el-row :gutter="12">
          <el-col :span="12">
            <el-form-item label="XÂùêÊ†á">
              <el-input-number 
                v-model="nodeData.x" 
                :min="0" 
                :step="10"
                @change="handleUpdate"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="YÂùêÊ†á">
              <el-input-number 
                v-model="nodeData.y" 
                :min="0" 
                :step="10"
                @change="handleUpdate"
              />
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-row :gutter="12">
          <el-col :span="12">
            <el-form-item label="ÂÆΩÂ∫¶">
              <el-input-number 
                v-model="nodeData.width" 
                :min="60" 
                :step="10"
                @change="handleUpdate"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="È´òÂ∫¶">
              <el-input-number 
                v-model="nodeData.height" 
                :min="40" 
                :step="10"
                @change="handleUpdate"
              />
            </el-form-item>
          </el-col>
        </el-row>
      </el-card>
      
      <!-- Áî®Êà∑‰ªªÂä°ÁâπÊúâÂ±ûÊÄß -->
      <el-card v-if="nodeData.type === 'userTask'" class="property-card" shadow="never">
        <template #header>
          <span class="card-title">üë§ Áî®Êà∑‰ªªÂä°ÈÖçÁΩÆ</span>
        </template>
        
        <el-form-item label="ÊâßË°å‰∫∫">
          <el-input 
            v-model="nodeData.properties.assignee" 
            placeholder="ËØ∑ËæìÂÖ•ÊâßË°å‰∫∫"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="ÂÄôÈÄâÁî®Êà∑">
          <el-input 
            v-model="nodeData.properties.candidateUsers" 
            placeholder="Â§ö‰∏™Áî®Êà∑Áî®ÈÄóÂè∑ÂàÜÈöî"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="ÂÄôÈÄâÁªÑ">
          <el-input 
            v-model="nodeData.properties.candidateGroups" 
            placeholder="Â§ö‰∏™ÁªÑÁî®ÈÄóÂè∑ÂàÜÈöî"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="Ë°®ÂçïKey">
          <el-input 
            v-model="nodeData.properties.formKey" 
            placeholder="ËØ∑ËæìÂÖ•Ë°®ÂçïKey"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="‰ºòÂÖàÁ∫ß">
          <el-slider 
            v-model="nodeData.properties.priority" 
            :min="0" 
            :max="100" 
            show-input
            @change="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="Âà∞ÊúüÊó∂Èó¥">
          <el-input 
            v-model="nodeData.properties.dueDate" 
            placeholder="Â¶ÇÔºöP1DÔºà1Â§©ÂêéÔºâ"
            @input="handleUpdate"
          />
        </el-form-item>
      </el-card>
      
      <!-- ÊúçÂä°‰ªªÂä°ÁâπÊúâÂ±ûÊÄß -->
      <el-card v-if="nodeData.type === 'serviceTask'" class="property-card" shadow="never">
        <template #header>
          <span class="card-title">‚öôÔ∏è ÊúçÂä°‰ªªÂä°ÈÖçÁΩÆ</span>
        </template>
        
        <el-form-item label="ÂÆûÁé∞ÊñπÂºè">
          <el-select 
            v-model="nodeData.properties.implementation" 
            placeholder="ËØ∑ÈÄâÊã©ÂÆûÁé∞ÊñπÂºè"
            @change="handleUpdate"
          >
            <el-option label="JavaÁ±ª" value="class" />
            <el-option label="Ë°®ËææÂºè" value="expression" />
            <el-option label="ÂßîÊâòË°®ËææÂºè" value="delegateExpression" />
            <el-option label="Â§ñÈÉ®‰ªªÂä°" value="external" />
          </el-select>
        </el-form-item>
        
        <el-form-item v-if="nodeData.properties.implementation === 'class'" label="JavaÁ±ª">
          <el-input 
            v-model="nodeData.properties.class" 
            placeholder="ËØ∑ËæìÂÖ•ÂÆåÊï¥Á±ªÂêç"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item v-if="nodeData.properties.implementation === 'expression'" label="Ë°®ËææÂºè">
          <el-input 
            v-model="nodeData.properties.expression" 
            placeholder="ËØ∑ËæìÂÖ•Ë°®ËææÂºè"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item v-if="nodeData.properties.implementation === 'delegateExpression'" label="ÂßîÊâòË°®ËææÂºè">
          <el-input 
            v-model="nodeData.properties.delegateExpression" 
            placeholder="ËØ∑ËæìÂÖ•ÂßîÊâòË°®ËææÂºè"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item v-if="nodeData.properties.implementation === 'external'" label="‰∏ªÈ¢ò">
          <el-input 
            v-model="nodeData.properties.topic" 
            placeholder="ËØ∑ËæìÂÖ•Â§ñÈÉ®‰ªªÂä°‰∏ªÈ¢ò"
            @input="handleUpdate"
          />
        </el-form-item>
      </el-card>
      
      <!-- ËÑöÊú¨‰ªªÂä°ÁâπÊúâÂ±ûÊÄß -->
      <el-card v-if="nodeData.type === 'scriptTask'" class="property-card" shadow="never">
        <template #header>
          <span class="card-title">üìú ËÑöÊú¨‰ªªÂä°ÈÖçÁΩÆ</span>
        </template>
        
        <el-form-item label="ËÑöÊú¨Ê†ºÂºè">
          <el-select 
            v-model="nodeData.properties.scriptFormat" 
            placeholder="ËØ∑ÈÄâÊã©ËÑöÊú¨Ê†ºÂºè"
            @change="handleUpdate"
          >
            <el-option label="JavaScript" value="javascript" />
            <el-option label="Groovy" value="groovy" />
            <el-option label="Python" value="python" />
            <el-option label="JRuby" value="jruby" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="ËÑöÊú¨ÂÜÖÂÆπ">
          <el-input 
            v-model="nodeData.properties.script" 
            type="textarea" 
            :rows="6"
            placeholder="ËØ∑ËæìÂÖ•ËÑöÊú¨ÂÜÖÂÆπ"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="ÁªìÊûúÂèòÈáè">
          <el-input 
            v-model="nodeData.properties.resultVariable" 
            placeholder="ËØ∑ËæìÂÖ•ÁªìÊûúÂèòÈáèÂêç"
            @input="handleUpdate"
          />
        </el-form-item>
      </el-card>
      
      <!-- ÁΩëÂÖ≥ÁâπÊúâÂ±ûÊÄß -->
      <el-card v-if="isGateway(nodeData.type)" class="property-card" shadow="never">
        <template #header>
          <span class="card-title">üîÄ ÁΩëÂÖ≥ÈÖçÁΩÆ</span>
        </template>
        
        <el-form-item v-if="nodeData.type === 'exclusiveGateway'" label="ÈªòËÆ§ÊµÅ">
          <el-input 
            v-model="nodeData.properties.defaultFlow" 
            placeholder="ËØ∑ËæìÂÖ•ÈªòËÆ§ÊµÅID"
            @input="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="ÁΩëÂÖ≥ÊñπÂêë">
          <el-select 
            v-model="nodeData.properties.gatewayDirection" 
            placeholder="ËØ∑ÈÄâÊã©ÁΩëÂÖ≥ÊñπÂêë"
            @change="handleUpdate"
          >
            <el-option label="ÂèëÊï£" value="diverging" />
            <el-option label="Ê±áËÅö" value="converging" />
            <el-option label="Ê∑∑Âêà" value="mixed" />
          </el-select>
        </el-form-item>
      </el-card>
      
      <!-- ÂÆöÊó∂‰∫ã‰ª∂ÁâπÊúâÂ±ûÊÄß -->
      <el-card v-if="nodeData.type === 'timerEvent'" class="property-card" shadow="never">
        <template #header>
          <span class="card-title">‚è∞ ÂÆöÊó∂‰∫ã‰ª∂ÈÖçÁΩÆ</span>
        </template>
        
        <el-form-item label="ÂÆöÊó∂Á±ªÂûã">
          <el-select 
            v-model="nodeData.properties.timerType" 
            placeholder="ËØ∑ÈÄâÊã©ÂÆöÊó∂Á±ªÂûã"
            @change="handleUpdate"
          >
            <el-option label="Êó∂Èó¥Êó•Êúü" value="timeDate" />
            <el-option label="ÊåÅÁª≠Êó∂Èó¥" value="timeDuration" />
            <el-option label="Âæ™ÁéØ" value="timeCycle" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="ÂÆöÊó∂Ë°®ËææÂºè">
          <el-input 
            v-model="nodeData.properties.timerDefinition" 
            placeholder="ËØ∑ËæìÂÖ•ÂÆöÊó∂Ë°®ËææÂºè"
            @input="handleUpdate"
          />
        </el-form-item>
      </el-card>
      
      <!-- Êâ©Â±ïÂ±ûÊÄß -->
      <el-card class="property-card" shadow="never">
        <template #header>
          <span class="card-title">üîß Êâ©Â±ïÂ±ûÊÄß</span>
        </template>
        
        <el-form-item label="ÂºÇÊ≠•ÊâßË°å">
          <el-switch 
            v-model="nodeData.properties.async" 
            @change="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="Êéí‰ªñÊâßË°å">
          <el-switch 
            v-model="nodeData.properties.exclusive" 
            @change="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="ÈáçËØïÊ¨°Êï∞">
          <el-input-number 
            v-model="nodeData.properties.retryTimeCycle" 
            :min="0" 
            :max="10"
            @change="handleUpdate"
          />
        </el-form-item>
        
        <el-form-item label="ÊñáÊ°£ËØ¥Êòé">
          <el-input 
            v-model="nodeData.properties.documentation" 
            type="textarea" 
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•ÊñáÊ°£ËØ¥Êòé"
            @input="handleUpdate"
          />
        </el-form-item>
      </el-card>
    </el-form>
  </div>
</template>

<script setup>
import { reactive, watch } from 'vue'

// Props
const props = defineProps({
  node: {
    type: Object,
    required: true
  }
})

// Emits
const emit = defineEmits(['update'])

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const nodeData = reactive({ ...props.node })

// ÁõëÂê¨ props ÂèòÂåñ
watch(
  () => props.node,
  (newNode) => {
    Object.assign(nodeData, newNode)
  },
  { deep: true }
)

// Â§ÑÁêÜÊõ¥Êñ∞
const handleUpdate = () => {
  emit('update', { ...nodeData })
}

// Ëé∑ÂèñËäÇÁÇπÁ±ªÂûãÈ¢úËâ≤
const getNodeTypeColor = (type) => {
  const colorMap = {
    start: 'success',
    end: 'danger',
    userTask: 'primary',
    serviceTask: 'warning',
    scriptTask: 'info',
    exclusiveGateway: 'warning',
    parallelGateway: 'success',
    timerEvent: 'primary'
  }
  return colorMap[type] || 'info'
}

// Ëé∑ÂèñËäÇÁÇπÁ±ªÂûãÂêçÁß∞
const getNodeTypeName = (type) => {
  const nameMap = {
    start: 'ÂºÄÂßãËäÇÁÇπ',
    end: 'ÁªìÊùüËäÇÁÇπ',
    userTask: 'Áî®Êà∑‰ªªÂä°',
    serviceTask: 'ÊúçÂä°‰ªªÂä°',
    scriptTask: 'ËÑöÊú¨‰ªªÂä°',
    exclusiveGateway: 'Êéí‰ªñÁΩëÂÖ≥',
    parallelGateway: 'Âπ∂Ë°åÁΩëÂÖ≥',
    timerEvent: 'ÂÆöÊó∂‰∫ã‰ª∂'
  }
  return nameMap[type] || type
}

// Âà§Êñ≠ÊòØÂê¶‰∏∫ÁΩëÂÖ≥
const isGateway = (type) => {
  return ['exclusiveGateway', 'parallelGateway', 'inclusiveGateway'].includes(type)
}
</script>

<style scoped>
.process-node-properties {
  padding: 0;
}

.property-card {
  margin-bottom: 16px;
  border: 1px solid #e4e7ed;
}

.property-card:last-child {
  margin-bottom: 0;
}

.card-title {
  font-weight: 600;
  color: #303133;
}

:deep(.el-card__header) {
  padding: 12px 16px;
  background: #f5f7fa;
  border-bottom: 1px solid #e4e7ed;
}

:deep(.el-card__body) {
  padding: 16px;
}

:deep(.el-form-item) {
  margin-bottom: 16px;
}

:deep(.el-form-item__label) {
  font-weight: 500;
  color: #606266;
}

:deep(.el-input__inner),
:deep(.el-textarea__inner) {
  border-radius: 4px;
}

:deep(.el-select) {
  width: 100%;
}

:deep(.el-input-number) {
  width: 100%;
}

:deep(.el-slider) {
  margin: 8px 0;
}
</style>